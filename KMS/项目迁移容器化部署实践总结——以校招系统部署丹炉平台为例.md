> 本文主要记录在校招系统从AWS集群迁移到丹炉平台中的实践经验总结。

## 需求背景
校招系统原有应用框架与数据库都部署在AWS上，随着部门AWS回迁丹炉平台的计划实施，优先切换数据库，导致系统业务逻辑与数据库之前的访问路径变长以及响应时间增加，影响到了用户体验，业务系统同步迁移丹炉平台刻不容缓。

## 迁移记录

当前系统为PHP + Laravel + Nginx部署形式，而在丹炉平台上主要以单个镜像来部署。

在之前[Docker-Compose在本地开发环境中的实践](https://kms.netease.com/article/18440)的基础上，虽然无法直接应用到丹炉平台上，进行基础镜像的整合。

在单个镜像中，主要分为基础依赖镜像、业务运行框架以及业务代码三大部分组成。

1. 在主要分为基础依赖镜像部分，为了实现整合PHP + Nginx，在Dockerhub中直接采用[webdevops/php-nginx:5.6](https://hub.docker.com/layers/webdevops/php-nginx/5.6/images/sha256-9b050ca792d06f998ba60d99d3e2981a3979bc6fd133d63d5d2230c3b322ccb7?context=explore)作为基础镜像。优点在于只需要替换对应的PHP和Nginx文件即可，无需在PHP基础镜像的基础上进行Nginx的编译安装，节约时间。

2. 在运行框架方面，通过搭建一个Laravel框架最小集，完成框架依赖的安装，在后续业务代码拷贝的时候，就无需多次进行项目依赖安装，提高镜像打包效率。

3. 在业务代码方面，业务代码复制以及相关定时crontab命令加载。在crontab加载时，一般镜像中默认以root用户运行，在业务日志记录等场景下，就会触发crontab写入日志后，非root用户运行的业务框架写入日志文件权限不足的问题。

最终完整系统镜像Dockerfile文件如下:
```
# 基础镜像
FROM hub.fuxi.netease.com/qa-web/consumemgr:base
ENV TZ=Asia/Shanghai

# 安装PHP相关依赖 + 常用命令 + 设置时区 + 清理
RUN sed -i s@/archive.ubuntu.com/@/mirrors.aliyun.com/@g /etc/apt/sources.list \
    && apt-get update \
    && apt-get upgrade -y \
    && apt-get install  -y \
        libfreetype6-dev \
        libmcrypt-dev \
        libpng-dev \
        libjpeg-dev \
        libpng-dev \
        openssl \
        libpng-dev \
        libssl-dev \
        iputils-ping \
        zlib1g-dev \
        procps \
        gawk \
        sudo

RUN docker-php-ext-configure gd \
    --enable-gd-native-ttf \
    --with-freetype-dir=/usr/include/freetype2 \
    --with-png-dir=/usr/include \
    --with-jpeg-dir=/usr/include \
    && docker-php-ext-install gd \
    && docker-php-ext-install mbstring zip pdo pdo_mysql opcache mcrypt \
    && pecl install mongodb-1.7.5 \
    && docker-php-ext-enable mongodb

RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone \
    && apt-get install tzdata \
    && apt-get clean \
    && apt-get autoclean \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# 安装composer
RUN curl -sS https://getcomposer.org/installer | php && \
    mv composer.phar /usr/local/bin/ && \
    ln -sf /usr/local/bin/composer.phar /usr/local/bin/composer

# 开启service
RUN docker-service-enable cron && \
    docker-service-enable ssh && \
    docker-service-enable syslog

# 创建用户sites
RUN groupadd -g 3000 sites
RUN useradd -u 3000 -mg sites sites

# 创建代码目录
RUN mkdir -p -m 777 /srv/sites/phpapi/consumemgr.leihuo.netease.com && \
    mkdir -p -m 777 /srv/logs/sites/consumemgr && \
    mkdir -p -m 777 /srv/logs/nginx && \
    mkdir -p -m 777 /var/run && \
    mkdir -p -m 777 /usr/local/log

# 设置文件目录权限
RUN chown -R 777 /srv/logs/ && \
    chown -R 777 /var/www/ && \
    chown -R 777 /var/run/ && \
    chown -R 777 /var/log

# 指定工作目录
WORKDIR /srv/sites/phpapi/consumemgr.leihuo.netease.com

# 拷贝框架基本代码，保证依赖只安装一次
COPY ./docker/laravel /srv/sites/phpapi/consumemgr.leihuo.netease.com/
# 覆盖当前项目对应依赖
COPY ./composer.json /srv/sites/phpapi/consumemgr.leihuo.netease.com/
COPY ./composer.lock /srv/sites/phpapi/consumemgr.leihuo.netease.com/

# 安装项目依赖
RUN composer config -g repo.packagist composer https://mirrors.aliyun.com/composer/ && \
    composer install --prefer-dist --no-interaction
ENV PATH="~/.composer/vendor/bin:./vendor/bin:${PATH}"

# 拷贝业务代码文件
COPY --chmod=777 . /srv/sites/phpapi/consumemgr.leihuo.netease.com/

# 替换PHP配置文件
COPY ./docker/98-webdevops.ini /opt/docker/etc/php/
COPY ./docker/98-webdevops.ini usr/local/etc/php/conf.d/
COPY ./docker/application.conf /opt/docker/etc/php/fpm/pool.d/
COPY ./docker/application.conf /usr/local/etc/php-fpm.d/

# 替换Nginx配置文件
COPY ./docker/nginx.conf /etc/nginx/
COPY ./docker/consumemgr-nginx.conf /etc/nginx/sites-enabled/

# 拷贝crontab命令
COPY --chmod=600 ./consumemgr-crontab /var/spool/cron/crontabs/
COPY --chmod=600 ./consumemgr-crontab /opt/docker/etc/cron/
COPY --chmod=600 ./consumemgr-crontab /etc/cron.d/

# 设置crontab
RUN (crontab -l ; cat "/etc/cron.d/consumemgr-crontab" ) | crontab

# 清空日志中lock文件
```

## 部署优化

- IP白名单

在原有服务器部署模式下，出口IP是唯一的，对于第三方服务来说，例如POPO消息发送、邮件发送等第三方服务白名单中申请记录也是唯一的。
迁移到丹炉平台部署在集群中，集群的出口IP为IP地址列表，在重新申请设置过程中，需要注意将集群出口IP地址完整包含。

- 域名切换

这里需要提前与SA沟通协作，保证容器内Nginx配置文件中server name，与丹炉平台应用自定义域名设置，与域名DNS解析策略保持一致。

- 数据迁移

在迁移Redis时，原有模式是多个业务共用一个Redis数据库，业务设置统一的前缀就显得尤为重要，这样方便通过前缀进行批量查询并导出。

## 后续优化

在部署实践过程中，也踩了不少坑，M1电脑编译amd64基础镜像的报错，Docker Desktop的禁用与WSL2搭建打包编辑环境的诸多问题，最终完成了系统平稳迁移，同时也存在很多指的优化的地方：

- 镜像自动打包推送

目前采用在台式机中的WSL2中，进行镜像的打包和推送，后续利用丹炉平台OpenAPI进行打包推送部署的自动化实践。

- rsync同步 

由于丹炉平台在更新应用时，采用的保证当前副本运行情况下，重新启动一个最新部分，最后再进行切换和停用旧副本。这样所需要的资源是一个副本资源的2倍。

在申请资源条件较小的情况下，后续计划在镜像中引入rsync，通过rsync进行开发机器与容积应用之间的代码的增量更新同步，实现在不更新应用的情况下，进行业务代码的平滑覆盖。

- 基础镜像版本更新

目前在优先保证系统稳定性下，迁移丹炉平台仍然保证PHP5.6 + Laravel5.4 + Nginx版本与以往一致，
由于存在一些语法不兼容情况，暂未升级，后续计划升级至PHP7 + Laravel6 + Nginx1.18来进一步提高系统性能。